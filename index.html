<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–∞–Ω–Ω–µ—Ä–æ–≤ –¥–ª—è LED-–±–æ—Ä—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .preview-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-header h1 {
            color: #333;
            font-size: 24px;
        }

        .preview-wrapper {
            overflow-x: auto;
            background: #f8f9fa;
        }

        #preview {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .settings-column h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: 600;
        }

        input[type="number"],
        input[type="text"],
        input[type="color"],
        input[type="file"],
        select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #007bff;
        }

        input[type="color"] {
            height: 45px;
            cursor: pointer;
        }

        select {
            cursor: pointer;
            background: white;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        button.danger {
            background: #dc3545;
            padding: 8px 16px;
            font-size: 13px;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.duplicate {
            background: #ffc107;
            padding: 8px 16px;
            font-size: 13px;
            color: #000;
        }

        button.duplicate:hover {
            background: #e0a800;
        }

        button.success {
            background: #28a745;
            padding: 14px 28px;
            font-size: 16px;
        }

        button.success:hover {
            background: #218838;
        }

        button.add-block {
            width: 100%;
            margin-top: 10px;
            background: #17a2b8;
        }

        button.add-block:hover {
            background: #138496;
        }

        .text-block {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }

        .text-block:hover {
            border-color: #007bff;
        }

        .text-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
        }

        .text-block-title {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .text-block-actions {
            display: flex;
            gap: 8px;
        }

        .info {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #004085;
            border-radius: 4px;
        }

        .divisors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .divisor-btn {
            padding: 8px 16px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            color: #333;
        }

        .divisor-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .divisor-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .text-blocks-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .text-blocks-container::-webkit-scrollbar {
            width: 8px;
        }

        .text-blocks-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .text-blocks-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .text-blocks-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .preview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- –ü—Ä–µ–≤—å—é -->
        <div class="preview-section">
            <div class="preview-header">
                <h1>–ü—Ä–µ–≤—å—é –±–∞–Ω–Ω–µ—Ä–∞</h1>
                <div class="button-group" style="margin: 0;">
                    <button class="success" onclick="downloadSVG()">üì• –°–∫–∞—á–∞—Ç—å SVG</button>
                    <button class="secondary" onclick="updatePreview()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
                </div>
            </div>
            <div class="preview-wrapper">
                <svg id="preview" width="1000" height="96"></svg>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="settings-section">
            <div class="settings-grid">
                <!-- –ö–æ–ª–æ–Ω–∫–∞ 1: –†–∞–∑–º–µ—Ä—ã –∏ —Ñ–æ–Ω -->
                <div class="settings-column">
                    <h2>‚öôÔ∏è –†–∞–∑–º–µ—Ä—ã –±–æ—Ä—Ç–∞</h2>

                    <div class="form-group">
                        <label>–û–±—â–∞—è –¥–ª–∏–Ω–∞ LED-–±–æ—Ä—Ç–∞ (px)</label>
                        <input type="number" id="totalLength" value="24960" min="100" step="100">
                    </div>

                    <div class="form-group">
                        <label>–í—ã—Å–æ—Ç–∞ –±–æ—Ä—Ç–∞ (px)</label>
                        <input type="number" id="boardHeight" value="96" min="10" step="1">
                    </div>

                    <div class="form-group">
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="sectionMode" value="auto" checked>
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            </label>
                            <label>
                                <input type="radio" name="sectionMode" value="manual">
                                –í—Ä—É—á–Ω—É—é
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="divisorsContainer">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏–Ω—É —Å–µ–∫—Ü–∏–∏ (–¥–µ–ª–∏—Ç–µ–ª–∏)</label>
                        <div class="divisors" id="divisorsList"></div>
                    </div>

                    <div class="form-group" id="manualSectionContainer" style="display: none;">
                        <label>–î–ª–∏–Ω–∞ —Å–µ–∫—Ü–∏–∏ (px)</label>
                        <input type="number" id="sectionLength" value="2496" min="100" step="100">
                    </div>

                    <div class="info" id="sectionInfo"></div>

                    <h2 style="margin-top: 30px;">üé® –§–æ–Ω</h2>

                    <div class="form-group">
                        <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                        <input type="color" id="bgColor" value="#1a1a1a">
                    </div>
                </div>

                <!-- –ö–æ–ª–æ–Ω–∫–∞ 2: –¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ -->
                <div class="settings-column">
                    <h2>üìù –¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏</h2>

                    <div class="text-blocks-container" id="textBlocksContainer">
                        <div id="textBlocks"></div>
                    </div>

                    <button class="add-block" onclick="addTextBlock()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/opentype.js@latest/dist/opentype.min.js"></script>
    <script>
        let textBlocks = [];
        let customFonts = {};
        let loadedFonts = {};
        let defaultFonts = {
            'giorgio': {
                name: 'Giorgio Sans LCG Heavy Italic',
                path: './fonts/Giorgio Sans LCG Heavy Italic.otf',
                font: null
            },
            'gilroy': {
                name: 'Gilroy Black',
                path: './fonts/Gilroy-Black.otf',
                font: null
            }
        };
        let fontsLoaded = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
        async function loadDefaultFonts() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Giorgio Sans
                const giorgioResponse = await fetch(defaultFonts.giorgio.path);
                if (giorgioResponse.ok) {
                    const giorgioBuffer = await giorgioResponse.arrayBuffer();
                    defaultFonts.giorgio.font = opentype.parse(giorgioBuffer);

                    const giorgioBlob = new Blob([giorgioBuffer], { type: 'font/otf' });
                    const giorgioUrl = URL.createObjectURL(giorgioBlob);
                    const giorgioFace = new FontFace(defaultFonts.giorgio.name, `url(${giorgioUrl})`);
                    const loadedGiorgio = await giorgioFace.load();
                    document.fonts.add(loadedGiorgio);
                    console.log('‚úÖ Giorgio Sans –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
            } catch (error) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Giorgio Sans:', error);
            }

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Gilroy
                const gilroyResponse = await fetch(defaultFonts.gilroy.path);
                if (gilroyResponse.ok) {
                    const gilroyBuffer = await gilroyResponse.arrayBuffer();
                    defaultFonts.gilroy.font = opentype.parse(gilroyBuffer);

                    const gilroyBlob = new Blob([gilroyBuffer], { type: 'font/otf' });
                    const gilroyUrl = URL.createObjectURL(gilroyBlob);
                    const gilroyFace = new FontFace(defaultFonts.gilroy.name, `url(${gilroyUrl})`);
                    const loadedGilroy = await gilroyFace.load();
                    document.fonts.add(loadedGilroy);
                    console.log('‚úÖ Gilroy Black –∑–∞–≥—Ä—É–∂–µ–Ω');
                }
            } catch (error) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Gilroy Black:', error);
            }

            fontsLoaded = true;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function () {
            await loadDefaultFonts();
            initEventListeners();
            initDefaultBlocks();
            updateDivisors();
            updatePreview();
        });

        function initEventListeners() {
            document.getElementById('totalLength').addEventListener('input', updateDivisors);
            document.getElementById('boardHeight').addEventListener('input', updatePreview);
            document.getElementById('bgColor').addEventListener('input', updatePreview);

            document.querySelectorAll('input[name="sectionMode"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'manual') {
                        document.getElementById('divisorsContainer').style.display = 'none';
                        document.getElementById('manualSectionContainer').style.display = 'block';
                    } else {
                        document.getElementById('divisorsContainer').style.display = 'block';
                        document.getElementById('manualSectionContainer').style.display = 'none';
                    }
                    updatePreview();
                });
            });

            document.getElementById('sectionLength').addEventListener('input', updatePreview);
        }

        function initDefaultBlocks() {
            // –ë–ª–æ–∫ 1: BetBoom
            const block1Id = Date.now();
            const block1 = {
                id: block1Id,
                text: 'BetBoom',
                fontSize: 136,
                color: '#ffffff',
                fontFamily: defaultFonts.gilroy.name,
                fontKey: 'gilroy',
                customFont: null,
                fontFile: null,
                verticalOffset: 1
            };
            if (defaultFonts.gilroy.font) {
                loadedFonts[block1Id] = defaultFonts.gilroy.font;
            }
            textBlocks.push(block1);

            // –ë–ª–æ–∫ 2: –§–†–ò–ë–ï–¢ –î–û 10 000
            const block2Id = Date.now() + 1;
            const block2 = {
                id: block2Id,
                text: '–§–†–ò–ë–ï–¢ –î–û 10 000',
                fontSize: 138,
                color: '#ffffff',
                fontFamily: defaultFonts.giorgio.name,
                fontKey: 'giorgio',
                customFont: null,
                fontFile: null,
                verticalOffset: 5
            };
            if (defaultFonts.giorgio.font) {
                loadedFonts[block2Id] = defaultFonts.giorgio.font;
            }
            textBlocks.push(block2);

            renderTextBlocks();
        }

        function findDivisors(num) {
            const divisors = [];
            for (let i = 1; i <= Math.sqrt(num); i++) {
                if (num % i === 0) {
                    divisors.push(i);
                    if (i !== num / i) {
                        divisors.push(num / i);
                    }
                }
            }
            return divisors.sort((a, b) => a - b);
        }

        function updateDivisors() {
            const totalLength = parseInt(document.getElementById('totalLength').value);
            const divisors = findDivisors(totalLength);
            const divisorsList = document.getElementById('divisorsList');
            const currentSectionLength = parseInt(document.getElementById('sectionLength').value);

            const filteredDivisors = divisors.filter(d => d >= 100 && d <= totalLength);

            divisorsList.innerHTML = '';
            filteredDivisors.forEach((divisor) => {
                const btn = document.createElement('button');
                btn.className = 'divisor-btn';
                btn.textContent = divisor;

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ —Å–µ–∫—Ü–∏–∏
                if (divisor === currentSectionLength) {
                    btn.classList.add('active');
                }

                btn.onclick = function () {
                    document.querySelectorAll('.divisor-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('sectionLength').value = divisor;
                    updatePreview();
                };

                divisorsList.appendChild(btn);
            });

            updateSectionInfo();
            updatePreview();
        }

        function updateSectionInfo() {
            const totalLength = parseInt(document.getElementById('totalLength').value);
            const sectionLength = parseInt(document.getElementById('sectionLength').value);
            const sectionsCount = Math.floor(totalLength / sectionLength);

            document.getElementById('sectionInfo').textContent =
                `–°–µ–∫—Ü–∏–π: ${sectionsCount} √ó ${sectionLength}px = ${sectionsCount * sectionLength}px`;
        }

        function addTextBlock() {
            const id = Date.now();
            const block = {
                id: id,
                text: '–¢–ï–ö–°–¢',
                fontSize: 60,
                color: '#ffffff',
                fontFamily: defaultFonts.giorgio.name,
                fontKey: 'giorgio',
                customFont: null,
                fontFile: null,
                verticalOffset: 0
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç
            if (defaultFonts.giorgio.font) {
                loadedFonts[id] = defaultFonts.giorgio.font;
            }

            textBlocks.push(block);
            renderTextBlocks();
            updatePreview();
        }

        function duplicateTextBlock(id) {
            const originalBlock = textBlocks.find(b => b.id === id);
            if (!originalBlock) return;

            const newId = Date.now();
            const duplicatedBlock = {
                ...originalBlock,
                id: newId
            };

            // –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç
            if (loadedFonts[id]) {
                loadedFonts[newId] = loadedFonts[id];
            }

            textBlocks.push(duplicatedBlock);
            renderTextBlocks();
            updatePreview();
        }

        function removeTextBlock(id) {
            textBlocks = textBlocks.filter(block => block.id !== id);
            delete loadedFonts[id];
            delete customFonts[id];
            renderTextBlocks();
            updatePreview();
        }

        function updateTextBlock(id, field, value) {
            const block = textBlocks.find(b => b.id === id);
            if (block) {
                block[field] = value;
                updatePreview();
            }
        }

        function handleFontChange(id, fontKey) {
            const block = textBlocks.find(b => b.id === id);
            if (!block) return;

            if (fontKey === 'custom') {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
                const fileInput = document.getElementById(`fontFile_${id}`);
                if (fileInput) {
                    fileInput.click();
                }
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç
                const font = defaultFonts[fontKey];
                if (font && font.font) {
                    block.fontFamily = font.name;
                    block.fontKey = fontKey;
                    block.customFont = null;
                    loadedFonts[id] = font.font;
                    renderTextBlocks();
                    updatePreview();
                }
            }
        }

        function handleFontUpload(id, file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const font = opentype.parse(e.target.result);
                        loadedFonts[id] = font;

                        const fontName = 'CustomFont' + id;
                        const blob = new Blob([e.target.result], { type: 'font/otf' });
                        const url = URL.createObjectURL(blob);
                        const fontFace = new FontFace(fontName, `url(${url})`);

                        fontFace.load().then(function (loadedFont) {
                            document.fonts.add(loadedFont);
                            customFonts[id] = fontName;
                            updateTextBlock(id, 'fontFamily', fontName);
                            updateTextBlock(id, 'fontKey', 'custom');
                            updateTextBlock(id, 'customFont', file.name);
                            updateTextBlock(id, 'fontFile', file);
                            renderTextBlocks();
                        }).catch(function (error) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–∞:', error);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —à—Ä–∏—Ñ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —à—Ä–∏—Ñ—Ç–∞:', error);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —à—Ä–∏—Ñ—Ç–∞');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function renderTextBlocks() {
            const container = document.getElementById('textBlocks');
            container.innerHTML = '';

            textBlocks.forEach((block, index) => {
                const div = document.createElement('div');
                div.className = 'text-block';
                div.innerHTML = `
                    <div class="text-block-header">
                        <span class="text-block-title">–ë–ª–æ–∫ ${index + 1}</span>
                        <div class="text-block-actions">
                            <button class="duplicate" onclick="duplicateTextBlock(${block.id})">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="danger" onclick="removeTextBlock(${block.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>–¢–µ–∫—Å—Ç</label>
                        <input type="text" value="${block.text}" 
                               oninput="updateTextBlock(${block.id}, 'text', this.value)">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>–†–∞–∑–º–µ—Ä (px)</label>
                            <input type="number" value="${block.fontSize}" min="10"
                                   oninput="updateTextBlock(${block.id}, 'fontSize', parseInt(this.value))">
                        </div>
                        
                        <div class="form-group">
                            <label>–¶–≤–µ—Ç</label>
                            <input type="color" value="${block.color}"
                                   oninput="updateTextBlock(${block.id}, 'color', this.value)">
                        </div>
                        
                        <div class="form-group">
                            <label>–°–º–µ—â–µ–Ω–∏–µ (px)</label>
                            <input type="number" value="${block.verticalOffset}"
                                   oninput="updateTextBlock(${block.id}, 'verticalOffset', parseInt(this.value))">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>–®—Ä–∏—Ñ—Ç</label>
                        <select onchange="handleFontChange(${block.id}, this.value)" id="fontSelect_${block.id}">
                            <option value="giorgio" ${block.fontKey === 'giorgio' ? 'selected' : ''}>Giorgio Sans LCG Heavy Italic</option>
                            <option value="gilroy" ${block.fontKey === 'gilroy' ? 'selected' : ''}>Gilroy Black</option>
                            <option value="custom" ${block.fontKey === 'custom' ? 'selected' : ''}>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —à—Ä–∏—Ñ—Ç...</option>
                        </select>
                        <input type="file" id="fontFile_${block.id}" accept=".ttf,.otf,.woff,.woff2" 
                               style="display: none;"
                               onchange="handleFontUpload(${block.id}, this.files[0])">
                        ${block.customFont ? `<small style="color: #28a745;">‚úì ${block.customFont}</small>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function measureTextWidth(text, fontSize, fontFamily) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = `${fontSize}px ${fontFamily}`;
            return context.measureText(text).width;
        }

        function updatePreview() {
            updateSectionInfo();

            const sectionLength = parseInt(document.getElementById('sectionLength').value);
            const height = parseInt(document.getElementById('boardHeight').value);
            const bgColor = document.getElementById('bgColor').value;

            if (textBlocks.length === 0) {
                renderSVG(sectionLength, height, bgColor, []);
                return;
            }

            const blockWidths = textBlocks.map(block =>
                measureTextWidth(block.text, block.fontSize, block.fontFamily)
            );

            const totalTextWidth = blockWidths.reduce((sum, width) => sum + width, 0);
            const n = textBlocks.length;

            const spacing = (sectionLength - totalTextWidth) / n;
            const startOffset = spacing / 2;

            let currentX = startOffset;
            const positionedBlocks = textBlocks.map((block, index) => {
                const x = currentX;
                currentX += blockWidths[index] + spacing;
                return { ...block, x, width: blockWidths[index] };
            });

            renderSVG(sectionLength, height, bgColor, positionedBlocks);
        }

        function renderSVG(width, height, bgColor, blocks) {
            const svg = document.getElementById('preview');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            let svgContent = `<rect width="${width}" height="${height}" fill="${bgColor}"/>`;

            // –í –ø—Ä–µ–≤—å—é –∏—Å–ø–æ–ª—å–∑—É–µ–º path –≤–º–µ—Å—Ç–æ text –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
            blocks.forEach(block => {
                const y = (height / 2) + block.verticalOffset;
                const font = loadedFonts[block.id];

                if (font) {
                    const pathData = textToPath(font, block.text, block.fontSize, block.x, y);
                    svgContent += `<path d="${pathData}" fill="${block.color}"/>`;
                } else {
                    // Fallback –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
                    svgContent += `
                        <text 
                            x="${block.x}" 
                            y="${y}" 
                            font-family="${block.fontFamily}" 
                            font-size="${block.fontSize}" 
                            fill="${block.color}"
                            text-anchor="start"
                            dominant-baseline="central"
                        >${escapeXml(block.text)}</text>
                    `;
                }
            });

            svg.innerHTML = svgContent;
        }

        function escapeXml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function textToPath(font, text, fontSize, x, y) {
            // –°–æ–∑–¥–∞–µ–º path —Å baseline –≤ —Ç–æ—á–∫–µ 0,0
            let path = font.getPath(text, 0, 0, fontSize);
            const bbox = path.getBoundingBox();

            // –ù–∞—Ö–æ–¥–∏–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä path (—Å–µ—Ä–µ–¥–∏–Ω–∞ –º–µ–∂–¥—É –≤–µ—Ä—Ö–æ–º –∏ –Ω–∏–∑–æ–º)
            const pathVisualCenter = (bbox.y1 + bbox.y2) / 2;

            // –°–º–µ—â–∞–µ–º path —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä –±—ã–ª –Ω–∞ y
            const adjustedY = y - pathVisualCenter;

            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π path —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–º–µ—â–µ–Ω–∏–µ–º
            path = font.getPath(text, x, adjustedY, fontSize);
            return path.toPathData(2);
        }

        async function downloadSVG() {
            const sectionLength = parseInt(document.getElementById('sectionLength').value);
            const height = parseInt(document.getElementById('boardHeight').value);
            const bgColor = document.getElementById('bgColor').value;

            const blockWidths = textBlocks.map(block =>
                measureTextWidth(block.text, block.fontSize, block.fontFamily)
            );

            const totalTextWidth = blockWidths.reduce((sum, width) => sum + width, 0);
            const n = textBlocks.length;
            const spacing = (sectionLength - totalTextWidth) / n;
            const startOffset = spacing / 2;

            let currentX = startOffset;
            const positionedBlocks = textBlocks.map((block, index) => {
                const x = currentX;
                currentX += blockWidths[index] + spacing;
                return { ...block, x, width: blockWidths[index] };
            });

            let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${sectionLength}" height="${height}" viewBox="0 0 ${sectionLength} ${height}" 
     xmlns="http://www.w3.org/2000/svg">
    <rect width="${sectionLength}" height="${height}" fill="${bgColor}"/>
`;

            for (const block of positionedBlocks) {
                const y = (height / 2) + block.verticalOffset;
                const font = loadedFonts[block.id];

                if (font) {
                    const pathData = textToPath(font, block.text, block.fontSize, block.x, y);
                    svgContent += `    <path d="${pathData}" fill="${block.color}"/>\n`;
                } else {
                    svgContent += `    <text x="${block.x}" y="${y}" font-family="${block.fontFamily}" font-size="${block.fontSize}" fill="${block.color}" text-anchor="start" dominant-baseline="central">${escapeXml(block.text)}</text>\n`;
                }
            }

            svgContent += '</svg>';

            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `led-banner-${sectionLength}x${height}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>