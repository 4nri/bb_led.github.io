<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–∞–Ω–Ω–µ—Ä–æ–≤ –¥–ª—è LED-–±–æ—Ä—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .preview-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .preview-header h1 {
            color: #333;
            font-size: 24px;
        }

        .preview-wrapper {
            overflow-x: auto;
            background: #f8f9fa;
        }

        #preview {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .settings-column h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            font-weight: 600;
        }

        input[type="number"],
        input[type="text"],
        input[type="color"],
        input[type="file"],
        select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
        }

        input[type="color"] {
            height: 45px;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        button.danger {
            background: #dc3545;
            padding: 8px 16px;
            font-size: 13px;
        }

        button.danger:hover {
            background: #c82333;
        }

        button.duplicate {
            background: #ffc107;
            padding: 8px 16px;
            font-size: 13px;
            color: #000;
        }

        button.duplicate:hover {
            background: #e0a800;
        }

        button.success {
            background: #28a745;
            padding: 14px 28px;
            font-size: 16px;
        }

        button.success:hover {
            background: #218838;
        }

        button.add-block {
            width: 100%;
            margin-top: 10px;
            background: #17a2b8;
        }

        button.add-block:hover {
            background: #138496;
        }

        .text-block {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }

        .text-block:hover {
            border-color: #007bff;
        }

        .text-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
        }

        .text-block-title {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .text-block-actions {
            display: flex;
            gap: 8px;
        }

        .info {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #004085;
            border-radius: 4px;
        }

        .divisors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .divisor-btn {
            padding: 8px 16px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            color: #333;
        }

        .divisor-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .divisor-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .text-blocks-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .text-blocks-container::-webkit-scrollbar {
            width: 8px;
        }

        .text-blocks-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .text-blocks-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .text-blocks-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        small {
            display: block;
            margin-top: 5px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .preview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- –ü—Ä–µ–≤—å—é -->
        <div class="preview-section">
            <div class="preview-header">
                <h1>–ü—Ä–µ–≤—å—é –±–∞–Ω–Ω–µ—Ä–∞</h1>
                <div class="button-group" style="margin: 0;">
                    <button class="success" onclick="downloadSVG()">üì• –°–∫–∞—á–∞—Ç—å SVG</button>
                    <button class="secondary" onclick="updatePreview()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é</button>
                </div>
            </div>
            <div class="preview-wrapper">
                <svg id="preview" width="1000" height="96"></svg>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="settings-section">
            <div class="settings-grid">
                <!-- –ö–æ–ª–æ–Ω–∫–∞ 1: –†–∞–∑–º–µ—Ä—ã –∏ —Ñ–æ–Ω -->
                <div class="settings-column">
                    <h2>‚öôÔ∏è –†–∞–∑–º–µ—Ä—ã –±–æ—Ä—Ç–∞</h2>

                    <div class="form-group">
                        <label>–û–±—â–∞—è –¥–ª–∏–Ω–∞ LED-–±–æ—Ä—Ç–∞ (px)</label>
                        <input type="number" id="totalLength" value="12000" min="100" step="100">
                    </div>

                    <div class="form-group">
                        <label>–í—ã—Å–æ—Ç–∞ –±–æ—Ä—Ç–∞ (px)</label>
                        <input type="number" id="boardHeight" value="96" min="10" step="1">
                    </div>

                    <div class="form-group">
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="sectionMode" value="auto" checked>
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            </label>
                            <label>
                                <input type="radio" name="sectionMode" value="manual">
                                –í—Ä—É—á–Ω—É—é
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="divisorsContainer">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏–Ω—É —Å–µ–∫—Ü–∏–∏ (–¥–µ–ª–∏—Ç–µ–ª–∏)</label>
                        <div class="divisors" id="divisorsList"></div>
                    </div>

                    <div class="form-group" id="manualSectionContainer" style="display: none;">
                        <label>–î–ª–∏–Ω–∞ —Å–µ–∫—Ü–∏–∏ (px)</label>
                        <input type="number" id="sectionLength" value="1000" min="100" step="100">
                    </div>

                    <div class="info" id="sectionInfo"></div>

                    <h2 style="margin-top: 30px;">üé® –§–æ–Ω</h2>

                    <div class="form-group">
                        <label>–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                        <input type="color" id="bgColor" value="#1a1a1a">
                    </div>
                </div>

                <!-- –ö–æ–ª–æ–Ω–∫–∞ 2: –¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ -->
                <div class="settings-column">
                    <h2>üìù –¢–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏</h2>

                    <div class="text-blocks-container" id="textBlocksContainer">
                        <div id="textBlocks"></div>
                    </div>

                    <button class="add-block" onclick="addTextBlock()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/opentype.js@latest/dist/opentype.min.js"></script>
    <script>
        let textBlocks = [];
        let customFonts = {};
        let loadedFonts = {};
        let defaultFont = null;
        let defaultFontName = 'Giorgio Sans LCG Heavy Italic';
        let fontLoaded = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞
        async function loadDefaultFont() {
            try {
                const response = await fetch('./fonts/Giorgio Sans LCG Heavy Italic.otf');
                if (!response.ok) {
                    throw new Error('–§–∞–π–ª —à—Ä–∏—Ñ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                const buffer = await response.arrayBuffer();
                defaultFont = opentype.parse(buffer);

                // –î–æ–±–∞–≤–ª—è–µ–º —à—Ä–∏—Ñ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const blob = new Blob([buffer], { type: 'font/otf' });
                const url = URL.createObjectURL(blob);
                const fontFace = new FontFace(defaultFontName, `url(${url})`);
                const loadedFontFace = await fontFace.load();
                document.fonts.add(loadedFontFace);

                fontLoaded = true;
                console.log('‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç Giorgio Sans –∑–∞–≥—Ä—É–∂–µ–Ω');
            } catch (error) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç:', error);
                defaultFontName = 'Arial, sans-serif';
                fontLoaded = false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async function () {
            await loadDefaultFont();
            initEventListeners();
            addTextBlock();
            updateDivisors();
            updatePreview();
        });

        function initEventListeners() {
            document.getElementById('totalLength').addEventListener('input', updateDivisors);
            document.getElementById('boardHeight').addEventListener('input', updatePreview);
            document.getElementById('bgColor').addEventListener('input', updatePreview);

            document.querySelectorAll('input[name="sectionMode"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'manual') {
                        document.getElementById('divisorsContainer').style.display = 'none';
                        document.getElementById('manualSectionContainer').style.display = 'block';
                    } else {
                        document.getElementById('divisorsContainer').style.display = 'block';
                        document.getElementById('manualSectionContainer').style.display = 'none';
                    }
                    updatePreview();
                });
            });

            document.getElementById('sectionLength').addEventListener('input', updatePreview);
        }

        function findDivisors(num) {
            const divisors = [];
            for (let i = 1; i <= Math.sqrt(num); i++) {
                if (num % i === 0) {
                    divisors.push(i);
                    if (i !== num / i) {
                        divisors.push(num / i);
                    }
                }
            }
            return divisors.sort((a, b) => a - b);
        }

        function updateDivisors() {
            const totalLength = parseInt(document.getElementById('totalLength').value);
            const divisors = findDivisors(totalLength);
            const divisorsList = document.getElementById('divisorsList');

            const filteredDivisors = divisors.filter(d => d >= 100 && d <= totalLength);

            divisorsList.innerHTML = '';
            filteredDivisors.forEach((divisor, index) => {
                const btn = document.createElement('button');
                btn.className = 'divisor-btn';
                btn.textContent = divisor;
                btn.onclick = function () {
                    document.querySelectorAll('.divisor-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('sectionLength').value = divisor;
                    updatePreview();
                };

                if (index === Math.floor(filteredDivisors.length / 2)) {
                    btn.classList.add('active');
                    document.getElementById('sectionLength').value = divisor;
                }

                divisorsList.appendChild(btn);
            });

            updateSectionInfo();
            updatePreview();
        }

        function updateSectionInfo() {
            const totalLength = parseInt(document.getElementById('totalLength').value);
            const sectionLength = parseInt(document.getElementById('sectionLength').value);
            const sectionsCount = Math.floor(totalLength / sectionLength);

            document.getElementById('sectionInfo').textContent =
                `–°–µ–∫—Ü–∏–π: ${sectionsCount} √ó ${sectionLength}px = ${sectionsCount * sectionLength}px`;
        }

        function addTextBlock() {
            const id = Date.now();
            const block = {
                id: id,
                text: '–¢–ï–ö–°–¢',
                fontSize: 60,
                color: '#ffffff',
                fontFamily: defaultFontName,
                customFont: fontLoaded ? 'Giorgio Sans LCG Heavy Italic.otf' : null,
                fontFile: null,
                verticalOffset: 0
            };

            // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
            if (fontLoaded && defaultFont) {
                loadedFonts[id] = defaultFont;
            }

            textBlocks.push(block);
            renderTextBlocks();
            updatePreview();
        }

        function duplicateTextBlock(id) {
            const originalBlock = textBlocks.find(b => b.id === id);
            if (!originalBlock) return;

            const newId = Date.now();
            const duplicatedBlock = {
                ...originalBlock,
                id: newId
            };

            // –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç
            if (loadedFonts[id]) {
                loadedFonts[newId] = loadedFonts[id];
            }

            textBlocks.push(duplicatedBlock);
            renderTextBlocks();
            updatePreview();
        }

        function removeTextBlock(id) {
            textBlocks = textBlocks.filter(block => block.id !== id);
            delete loadedFonts[id];
            delete customFonts[id];
            renderTextBlocks();
            updatePreview();
        }

        function updateTextBlock(id, field, value) {
            const block = textBlocks.find(b => b.id === id);
            if (block) {
                block[field] = value;
                updatePreview();
            }
        }

        function handleFontUpload(id, file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const font = opentype.parse(e.target.result);
                        loadedFonts[id] = font;

                        const fontName = 'CustomFont' + id;
                        const blob = new Blob([e.target.result], { type: 'font/otf' });
                        const url = URL.createObjectURL(blob);
                        const fontFace = new FontFace(fontName, `url(${url})`);

                        fontFace.load().then(function (loadedFont) {
                            document.fonts.add(loadedFont);
                            customFonts[id] = fontName;
                            updateTextBlock(id, 'fontFamily', fontName);
                            updateTextBlock(id, 'customFont', file.name);
                            updateTextBlock(id, 'fontFile', file);
                        }).catch(function (error) {
                            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–∞:', error);
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —à—Ä–∏—Ñ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                        });
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —à—Ä–∏—Ñ—Ç–∞:', error);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —à—Ä–∏—Ñ—Ç–∞');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function renderTextBlocks() {
            const container = document.getElementById('textBlocks');
            container.innerHTML = '';

            textBlocks.forEach((block, index) => {
                const div = document.createElement('div');
                div.className = 'text-block';
                div.innerHTML = `
                    <div class="text-block-header">
                        <span class="text-block-title">–ë–ª–æ–∫ ${index + 1}</span>
                        <div class="text-block-actions">
                            <button class="duplicate" onclick="duplicateTextBlock(${block.id})">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="danger" onclick="removeTextBlock(${block.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>–¢–µ–∫—Å—Ç</label>
                        <input type="text" value="${block.text}" 
                               oninput="updateTextBlock(${block.id}, 'text', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
                        <input type="number" value="${block.fontSize}" min="10"
                               oninput="updateTextBlock(${block.id}, 'fontSize', parseInt(this.value))">
                    </div>
                    
                    <div class="form-group">
                        <label>–¶–≤–µ—Ç</label>
                        <input type="color" value="${block.color}"
                               oninput="updateTextBlock(${block.id}, 'color', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —à—Ä–∏—Ñ—Ç (TTF, OTF, WOFF)</label>
                        <input type="file" accept=".ttf,.otf,.woff,.woff2"
                               onchange="handleFontUpload(${block.id}, this.files[0])">
                        ${block.customFont ? `<small style="color: #28a745;">‚úì ${block.customFont}</small>` : ''}
                    </div>
                    
                    <div class="form-group">
                        <label>–°–º–µ—â–µ–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (px)</label>
                        <input type="number" value="${block.verticalOffset}"
                               oninput="updateTextBlock(${block.id}, 'verticalOffset', parseInt(this.value))">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function measureTextWidth(text, fontSize, fontFamily) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = `${fontSize}px ${fontFamily}`;
            return context.measureText(text).width;
        }

        function updatePreview() {
            updateSectionInfo();

            const sectionLength = parseInt(document.getElementById('sectionLength').value);
            const height = parseInt(document.getElementById('boardHeight').value);
            const bgColor = document.getElementById('bgColor').value;

            if (textBlocks.length === 0) {
                renderSVG(sectionLength, height, bgColor, []);
                return;
            }

            // –ò–∑–º–µ—Ä—è–µ–º —à–∏—Ä–∏–Ω—É –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
            const blockWidths = textBlocks.map(block =>
                measureTextWidth(block.text, block.fontSize, block.fontFamily)
            );

            const totalTextWidth = blockWidths.reduce((sum, width) => sum + width, 0);
            const n = textBlocks.length;

            // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–û–†–ú–£–õ–ê –¥–ª—è —Å—Ç—ã–∫–æ–≤–∫–∏ –ø–∞–Ω–µ–ª–µ–π:
            // –£ –Ω–∞—Å n –±–ª–æ–∫–æ–≤ —Ç–µ–∫—Å—Ç–∞, –∑–Ω–∞—á–∏—Ç n –ø—Ä–æ–º–µ–∂—É—Ç–∫–æ–≤ –º–µ–∂–¥—É –Ω–∏–º–∏ (–≤–∫–ª—é—á–∞—è —Å—Ç—ã–∫–∏ –ø–∞–Ω–µ–ª–µ–π)
            // spacing = (sectionLength - totalTextWidth) / n
            // –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ spacing/2 –æ—Ç –Ω–∞—á–∞–ª–∞

            const spacing = (sectionLength - totalTextWidth) / n;
            const startOffset = spacing / 2;

            // –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –±–ª–æ–∫–∏
            let currentX = startOffset;
            const positionedBlocks = textBlocks.map((block, index) => {
                const x = currentX;
                currentX += blockWidths[index] + spacing;
                return { ...block, x, width: blockWidths[index] };
            });

            renderSVG(sectionLength, height, bgColor, positionedBlocks);
        }

        function renderSVG(width, height, bgColor, blocks) {
            const svg = document.getElementById('preview');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            let svgContent = `<rect width="${width}" height="${height}" fill="${bgColor}"/>`;

            blocks.forEach(block => {
                // –¶–µ–Ω—Ç—Ä –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ + offset –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
                const y = (height / 2) + block.verticalOffset;
                svgContent += `
                    <text 
                        x="${block.x}" 
                        y="${y}" 
                        font-family="${block.fontFamily}" 
                        font-size="${block.fontSize}" 
                        fill="${block.color}"
                        text-anchor="start"
                        dominant-baseline="central"
                    >${escapeXml(block.text)}</text>
                `;
            });

            svg.innerHTML = svgContent;
        }

        function escapeXml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function textToPath(font, text, fontSize, x, y) {
            // dominant-baseline="central" —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ cap-height (–≤—ã—Å–æ—Ç–µ –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤)
            // –∞ –Ω–µ –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º boundaries —Å –≤—ã–Ω–æ—Å–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏

            const scale = fontSize / font.unitsPerEm;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º capHeight - —ç—Ç–æ –≤—ã—Å–æ—Ç–∞ –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤
            // –ï—Å–ª–∏ capHeight –Ω–µ—Ç –≤ —à—Ä–∏—Ñ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º ascender –∫–∞–∫ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
            const capHeight = (font.tables.os2 && font.tables.os2.sCapHeight)
                ? font.tables.os2.sCapHeight * scale
                : font.ascender * scale * 0.7; // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

            // –¶–µ–Ω—Ç—Ä cap-height –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ y
            // baseline –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω–∏–∑—É, –ø–æ—ç—Ç–æ–º—É:
            const baselineY = y + (capHeight / 2);

            const path = font.getPath(text, x, baselineY, fontSize);
            return path.toPathData(2);
        }

        async function downloadSVG() {
            const sectionLength = parseInt(document.getElementById('sectionLength').value);
            const height = parseInt(document.getElementById('boardHeight').value);
            const bgColor = document.getElementById('bgColor').value;

            const blockWidths = textBlocks.map(block =>
                measureTextWidth(block.text, block.fontSize, block.fontFamily)
            );

            const totalTextWidth = blockWidths.reduce((sum, width) => sum + width, 0);
            const n = textBlocks.length;
            const spacing = (sectionLength - totalTextWidth) / n;
            const startOffset = spacing / 2;

            let currentX = startOffset;
            const positionedBlocks = textBlocks.map((block, index) => {
                const x = currentX;
                currentX += blockWidths[index] + spacing;
                return { ...block, x, width: blockWidths[index] };
            });

            let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${sectionLength}" height="${height}" viewBox="0 0 ${sectionLength} ${height}" 
     xmlns="http://www.w3.org/2000/svg">
    <rect width="${sectionLength}" height="${height}" fill="${bgColor}"/>
`;

            for (const block of positionedBlocks) {
                const y = (height / 2) + block.verticalOffset;
                const font = loadedFonts[block.id];

                if (font) {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –∫—Ä–∏–≤—ã–µ
                    const pathData = textToPath(font, block.text, block.fontSize, block.x, y);
                    svgContent += `    <path d="${pathData}" fill="${block.color}"/>\n`;
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç
                    svgContent += `    <text x="${block.x}" y="${y}" font-family="${block.fontFamily}" font-size="${block.fontSize}" fill="${block.color}" text-anchor="start" dominant-baseline="central">${escapeXml(block.text)}</text>\n`;
                }
            }

            svgContent += '</svg>';

            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `led-banner-${sectionLength}x${height}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>